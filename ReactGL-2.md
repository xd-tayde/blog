# React å®è·µæ­ç§˜ä¹‹æ—…ï¼Œä¸­é«˜çº§å‰ç«¯å¿…å¤‡(ä¸‹)

## å¼•è¨€

ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦å®ç°äº† **JSX** åœ¨ `WebGL` ä¸Šçš„æ¸²æŸ“ä¸æ›´æ–°ï¼Œå¯¹ **è™šæ‹ŸDOM** å’Œ **Diff** æœ‰äº†æ›´æ·±çš„äº†è§£ï¼Œä½†ç›¸æ¯”äºæˆ‘ä»¬ä½¿ç”¨çš„ `React`ï¼Œè¿˜ç¼ºä¹äº†ä¹‹ä¸­å¾ˆé‡è¦çš„ä¸€ç¯ --- **ç»„ä»¶æ¨¡å¼**ã€‚

æƒ³å¿…å¤§å®¶èƒ½è®¤åŒï¼ŒReactç»„ä»¶(`Component`)å…·æœ‰ **å¼ºå¤§çš„åŠŸèƒ½ï¼Œé«˜æ‹“å±•æ€§å’Œé«˜è§£è€¦æ€§**ï¼Œåœ¨å…¶åŸºç¡€ä¸Šæ„å»ºçš„å„ç§ `UI` ç»„ä»¶æ¡†æ¶å®Œå…¨æ”¹å˜äº†ä¼ ç»Ÿçš„ Web å¼€å‘æ¨¡å¼ï¼Œæˆä¸ºäº†Web ä¸­çš„å¤§å‹å¤æ‚åº”ç”¨æä¾›äº†ä¸€ç§å¾ˆå¥½çš„æ„å»ºæ¨¡å¼å’Œä¿éšœï¼Œä¹Ÿè®©æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ä¹Ÿæœ‰äº†è´¨çš„å˜åŒ–ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸Šä¸€ç¯‡çš„å®ç°åŸºç¡€ä¸Šï¼ŒåŠ å…¥ `React` ç»„ä»¶æ¨¡å¼ï¼Œå¹¶åœ¨å®ç°çš„è¿‡ç¨‹ä¸­é€‚æ—¶çš„å»è®²è§£ä¸€äº›åŸç†å’Œæ€ç»´ï¼Œä¹Ÿæœ‰åˆ©äºå¤§å®¶ **ç”±æµ…å…¥æ·±çš„ç†è§£** å’Œ **ç¼–ç¨‹æ€ç»´ä¸Šçš„æå‡**ã€‚

ç”±äºä¸‹ç¯‡æ˜¯å®Œå…¨ä»¥ä¸Šç¯‡ä½œä¸ºåŸºç¡€çš„ã€‚æ‰€ä»¥å¦‚æœä½ è¿˜æ²¡çœ‹è¿‡ä¸Šç¯‡ï¼Œè¯·ä¼˜å…ˆçŒ›æˆ³:

**[React å®è·µæ­ç§˜ä¹‹æ—…ï¼Œä¸­é«˜çº§å‰ç«¯å¿…å¤‡(ä¸Š) ->](https://github.com/xd-tayde/blog/blob/master/ReactGL-1.md)**

## ç¬¬ä¸ƒç«™: ç ´ç¢ä¹‹å¢Ÿ - Component

**ä»£ç å¤ç”¨æ€§**ï¼Œå‘æ¥æ˜¯ç¼–ç¨‹é¢†åŸŸä¸€ä¸ªæ ¸å¿ƒçš„ç†å¿µã€‚æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨ **å‡½æ•°ã€ç±»** æ–¹å¼è¿›è¡Œä»£ç çš„å°è£…ï¼Œä½†è¿™é‡Œæœ‰ä¸ªç—›ç‚¹: 

**Web ä¸­ UI ä¸ é€»è¾‘ çš„åˆ†ç¦»çš„ç‰¹æ€§ï¼Œå¯¼è‡´è¾ƒéš¾ä¼˜é›…åœ°æ•´åˆå°è£…ã€‚**

é€šå¸¸æˆ‘ä»¬éœ€è¦å¼• `JS`ã€`CSS`ï¼Œå†åœ¨ `HTML` ä¸­æŒ‰è§„å®šä¹¦å†™ç»“æ„ï¼Œæœ€åå†åˆå§‹åŒ–åº“ã€‚æ•´ä¸ªè¿‡ç¨‹ååˆ†å‰²è£‚ï¼Œä¸”ä¸ä¼˜é›…ã€‚

è€Œ `React Component` å¸®æˆ‘ä»¬è§£å†³äº†è¿™ä¸ªç—›ç‚¹ï¼Œå³ä¿æŒäº† **åŠ¨æ€UI** ä¸ **é€»è¾‘** çš„åˆ†ç¦»ï¼Œåˆæœ‰äº†å…¨æ–°çš„æ•´åˆæ–¹å¼ã€‚ä»è€Œè®© UI ç»„ä»¶å˜å¾—éå¸¸çš„ **é«˜æ•ˆæ˜“ç”¨**ï¼Œåªéœ€è¦åœ¨ç»“æ„ä¸­ä»¥æ ‡ç­¾çš„å½¢å¼å¼•å…¥å³å¯ã€‚

æˆ‘ä»¬å°±ç»§ç»­åœ¨ä¸Šç¯‡æ–‡ç« çš„åŸºç¡€ä¸Šï¼ŒåŠ å…¥ `Component` çš„ç‰¹æ€§ã€‚åŸºäº `JSX` çš„å˜é‡ä¼ é€’ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°ä¸€ä¸ª `Component` ç±»ï¼Œå¹¶é’ˆå¯¹æ€§åœ°å»å®Œæˆç»„ä»¶çš„ **æ¸²æŸ“å’Œæ›´æ–°** å³å¯ã€‚

> TIPs: 
> 
> ç”±äºç»„ä»¶çš„åŠ å…¥ï¼Œè¿™æ—¶æˆ‘ä»¬çš„ **è™šæ‹ŸDOM(VNode)** å°±åŒ…å«äº†ä¸¤ç§ç±»å‹: **ç»„ä»¶èŠ‚ç‚¹(compVNode)** å’Œ **å…ƒç´ èŠ‚ç‚¹(elVNode)**ã€‚åç»­éƒ½ä¼šä»¥æ­¤åŒºåˆ†ï¼Œä¾¿äºè®²è§£ã€‚

```js
// ç»„ä»¶åŸºç±»
class Component {
    // é€šè¿‡ä¿æŒä¸‰ä»½ä¸åŒçš„æ—¶æœŸçš„å¿«ç…§
    // æœ‰åˆ©äºå¯¹ç»„ä»¶çš„çŠ¶æ€åŠå±æ€§çš„ç®¡ç†å’Œè¿½è¸ª

    // å±æ€§
    public __prevProps
    public props = {}
    public __nextProps
    
    // çŠ¶æ€
    public __prevState
    public state = {}
    public __nextState
    
    // å‚¨å­˜å½“å‰ç»„ä»¶æ¸²æŸ“å‡ºçš„ VNode
    public __vnode
    
    // å‚¨å­˜ ç»„ä»¶èŠ‚ç‚¹
    public __component
    
    constructor(props) {
        // åˆå§‹åŒ–å‚æ•°
        this.props = props
    }
    public render(): any { return null }
    public __createVNode() {
        // è¯¥æ–¹æ³•ç”¨äºå°è£…é‡æ–°æ‰§è¡Œ render çš„é€»è¾‘
    
        // state ä¸ props çŠ¶æ€å˜æ›´çš„é€»è¾‘
        this.__prevProps = this.props
        this.__prevState = this.state

        this.props = this.__nextProps
        this.state = this.__nextState

        this.__nextState = this.__nextProps = undefined
        
        // é‡æ–°æ‰§è¡Œ render ç”Ÿæˆ VNode
        this.__vnode = this.render()
        
        return this.__vnode
    }
}
```

æœ‰äº†è¿™ä¸ªç±»åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ `React` çš„æ–¹å¼ç»§æ‰¿å‡º **è‡ªå®šä¹‰ç»„ä»¶** è¿›è¡Œæ¸²æŸ“:

```js
class App extends Component {
    constructor(props) {
        super(props)
        this.state = {
            content: 'ReactWebGL Component, Hello World',
        }
    }
    public render() {
        return (
            <Container name="parent">
                {this.state.content}
            </Container>
        )
    }
}

render(<App />, game.stage)
```

ç”±äºæˆ‘ä»¬ä¹‹å‰æè¿‡ï¼Œ`JSX` æ˜¯ä»¥ **å˜é‡ä¼ é€’** çš„å½¢å¼ç¼–è¯‘çš„ã€‚å› æ­¤å°† `<App />` è½¬æ¢æˆ `VNode` åï¼Œå…¶ **`vnode.type` çš„å€¼ä¾¿æ˜¯ `App` è¿™ä¸ªç±»**ï¼Œå¹¶ä¸æ˜¯ç±»ä¼¼ `div` é‚£æ ·çš„ **å­—ç¬¦ä¸²æ ‡ç­¾å**ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª **ç»„ä»¶åˆå§‹åŒ–** çš„å‡½æ•°(`Component`)ã€‚è¿™ä¸ªå‡½æ•°çš„ä¸»è¦åŠŸèƒ½æ˜¯:  

**å®ä¾‹åŒ–ç»„ä»¶å¹¶è·å–ç»„ä»¶ `render` æ–¹æ³•ä¸­è¿”å›çš„ å…ƒç´ èŠ‚ç‚¹ã€‚**

```js
// æ¸²æŸ“ç»„ä»¶
function renderComponent(compVNode) {
    const { type: Comp, props } = compVNode
    let instance = compVNode.instance
    
    // å½“ instance å·²ç»å­˜åœ¨æ—¶ï¼Œåˆ™ä¸éœ€è¦é‡æ–°åˆ›å»ºå®ä¾‹
    if (!instance) {
        // ä¼ å…¥ propsï¼Œåˆå§‹åŒ–ç»„ä»¶å®ä¾‹
        // æ”¯æŒ ç±»ç»„ä»¶ æˆ–è€… å‡½æ•°ç»„ä»¶
        if (Comp.prototype && Comp.prototype.render) {
            instance = new Comp(props)
        } else {
            instance = new Component(props)
            instance.constructor = Comp
            instance.render = () => instance.constructor(props)
        }
        
	    // åˆæ¬¡æ¸²æŸ“æ—¶
	    // å°†æ¥çš„å±æ€§ä¸çŠ¶æ€å…¶å®ä¾¿æ˜¯ä¸å½“å‰å€¼ä¸€è‡´
	    instance.__nextProps = props
	    instance.__nextState = instance.state
    }    
    
    // è°ƒç”¨ render è·å– VNode
    const vnode = instance.__createVNode()

    // ç»„ä»¶ã€å…ƒç´ ã€å®ä¾‹ä¹‹é—´ä¿æŒç›¸äº’å¼•ç”¨ï¼Œæœ‰åˆ©äºåŒå‘è¿æ¥æ•´æ£µè™šæ‹Ÿæ ‘
    instance.__component = compVNode
    compVNode.instance = instance
    compVNode.vnode = vnode
    vnode.component = compVNode

    return vnode
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦åœ¨ `createElm` çš„å‡½æ•°åŠ å…¥: å½“ä¼ å…¥çš„ä¸º **ç»„ä»¶èŠ‚ç‚¹** æ—¶è°ƒç”¨å‡½æ•°åˆå§‹åŒ–ç”Ÿæˆ **å…ƒç´ èŠ‚ç‚¹**ï¼Œåç»­åªéœ€è¦ç»§ç»­åŸæœ‰çš„é€»è¾‘ç»§ç»­åˆ›å»ºï¼Œä¾¿èƒ½æ­£ç¡®æ¸²æŸ“ç»„ä»¶ã€‚

```js
function createElm(vnode) {
	// å½“ä¸ºç»„ä»¶æ—¶ï¼Œåˆå§‹åŒ–ç»„ä»¶
	// é‡æ–°èµ‹å€¼æˆ å…ƒç´ èŠ‚ç‚¹
    if (typeof vnode.type === 'function') {
        vnode = renderComponent(vnode) 
    }
    
    // ç»´æŒåŸæœ‰é€»è¾‘
    ...
    
    return vnode.elm
}
```

ä¿å­˜æ‰§è¡Œï¼Œé¡µé¢ä¸­å·²ç»èƒ½æ­£ç¡®çš„æ¸²æŸ“å‡º `<App>` ç»„ä»¶äº†ã€‚å»¶ç»­ä¹‹å‰çš„é€»è¾‘ï¼Œåœ¨å®Œæˆåˆæ¬¡æ¸²æŸ“åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç»„ä»¶çš„æ›´æ–°ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„ `this.setState`äº†ã€‚

## ç¬¬å…«ç«™: å‡€åŒ–ä¹‹åŒ™ - setState

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å®ç°äº† **è™šæ‹ŸDOM** æ›´æ–°å‡½æ•° `diff`ã€‚å‚æ•°ä¸º **æ–°æ—§è™šæ‹ŸèŠ‚ç‚¹(`oldVNode`ã€`newVNode`)**ã€‚æ‰€ä»¥ç»„ä»¶æ›´æ–°çš„åŸç†ä¹Ÿä¸€æ ·: 

**è·å–ç»„ä»¶å®ä¾‹å…ˆåæ¸²æŸ“çš„æ–°æ—§ `VNode` å†è§¦å‘ `diff` å‡½æ•°ã€‚**

åœ¨åˆšæ‰ `Component `çš„æ¸²æŸ“ä¸­ï¼Œæˆ‘ä»¬å·²ç»æŠŠ `render` ç”Ÿæˆçš„ `VNode` ä¿å­˜åœ¨ `this.__vnode` ä¸Šï¼Œè¿™ä¾¿æ˜¯åˆå§‹åŒ–æ—¶ç”Ÿæˆçš„ **æ—§è™šæ‹ŸèŠ‚ç‚¹(`oldVNode`)**ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯: 

**`setState` ä¸­ æ›´æ–°çŠ¶æ€ï¼Œè°ƒç”¨ `render` ç”Ÿæˆ æ–°è™šæ‹ŸèŠ‚ç‚¹(`newVNode`)ï¼Œè§¦å‘ `diff` æ›´æ–°ã€‚**

å› æ­¤æˆ‘ä»¬åœ¨ç±»ä¸Šæ–°å¢ä¸¤ä¸ªæ–¹æ³•: `setState` å’Œ `__update`:

```js
class Component {
	// å…¶ä½™æ–¹æ³•
	...
	
	// æ›´æ–°å‡½æ•°
	public __update = () => {
        // ä¸´æ—¶å­˜å‚¨ æ—§è™šæ‹ŸèŠ‚ç‚¹ (oldVNode)
        const oldVNode = this.__vnode
        
        this.__nextProps = this.props
        if (!this.__nextState) this.__nextState = this.state

        // é‡æ–°ç”Ÿæˆ æ–°è™šæ‹ŸèŠ‚ç‚¹(newVNode)
        this.__vnode = this.__createVNode()

        // è°ƒç”¨ diffï¼Œæ›´æ–° VNode
        diff(oldVNode, this.__vnode)
    }
    
    // æ›´æ–°çŠ¶æ€
    public setState(partialState, callback?) {
        // åˆå¹¶çŠ¶æ€, æš‚å­˜äº å³å°†æ›´æ–°æ€ ä¸­
        if (typeof partialState === 'function') {
            partialState = partialState(this.state)
        }
        this.__nextState = {
            ...this.state,
            ...partialState,
        }

        // è°ƒç”¨æ›´æ–°ï¼Œå¹¶æ‰§è¡Œå›è°ƒ
        this.__update()
        callback && callback()
    }
}
```

### æ›´æ–°ä¼˜åŒ–
 
åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º: `setState` å°è£…äº† `diff` æ–¹æ³•ã€‚ä½†ç”±äº `diff` çš„å¤æ‚åº¦ï¼Œæ€§èƒ½çš„ä¼˜åŒ–ä¼šæ˜¯ä¸€ä¸ªæˆ‘ä»¬éœ€è¦ç€é‡è€ƒè™‘çš„ç‚¹ã€‚æ¯æ‰§è¡Œä¸€æ¬¡ `setState`ï¼Œå°±éœ€è¦é‡æ–°ç”Ÿæˆ `newVNode` è¿›è¡Œ `diff`ã€‚å› æ­¤ï¼Œå½“ç»„ä»¶éå¸¸å¤æ‚æ—¶æˆ–è€…è¿ç»­æ›´æ–°æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ **ä¸»è¿›ç¨‹çš„é˜»å¡ï¼Œé€ æˆé¡µé¢çš„å¡æ­»ã€‚**

è¿™é‡Œæˆ‘ä»¬éœ€è¦æœ‰ä¸¤ä¸ªä¼˜åŒ–:

- **`setState` å¼‚æ­¥åŒ–ï¼Œé¿å…é˜»å¡ä¸»è¿›ç¨‹ï¼›**

- **`setState` åˆå¹¶ï¼Œå¤šæ¬¡è¿ç»­è°ƒç”¨ä¼šè¢«æœ€ç»ˆåˆå¹¶æˆä¸€æ¬¡ï¼›**

	- åŒä¸€ç»„ä»¶ **è¿ç»­å¤šæ¬¡æ›´æ–°**ï¼›
	
	- çˆ¶å­çº§è¿ç»­è§¦å‘æ›´æ–°ï¼Œç”±äº **çˆ¶çº§æ›´æ–°å…¶å®å·²ç»åŒ…å«å­çº§çš„æ›´æ–°**ï¼Œæ­¤æ—¶å¦‚æœå­çº§å†è‡ªæˆ‘æ›´æ–°ä¸€æ¬¡ï¼Œåˆ™å°±å˜æˆäº†ä¸€ç§æ— è°“æ¶ˆè€—ï¼› 

ä¸ºäº†è¿™ä¸ªä¼˜åŒ–ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—åŠŸèƒ½: 

- **å¯ä»¥å¼‚æ­¥åŒ–è°ƒç”¨æ›´æ–°**ï¼›

- **ä¸ºç»„ä»¶æ ‡æ³¨ï¼Œä¿è¯ä¸€æ¬¡å¾ªç¯ä¸­å•ä¸ªç»„ä»¶åªä¼šæ›´æ–°ä¸€æ¬¡**ï¼›

æˆ‘ä»¬å…ˆæ¥å®ç°ä¸ª å¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—: 

```js
// æ›´æ–°å¼‚æ­¥åŒ–ï¼Œé‡‡ç”¨å±äºå¾®ä»»åŠ¡çš„ Promiseï¼Œå…¼å®¹æ€§ä½¿ç”¨ setTimeout
// è¿™é‡Œä½¿ç”¨å¾®ä»»åŠ¡ï¼Œå¯ä»¥ä¿è¯å®ä»»åŠ¡çš„ä¼˜å…ˆæ‰§è¡Œ
// ä¿è¯ä¾‹å¦‚ UIæ¸²æŸ“ ç­‰æ›´ä¸ºé‡è¦çš„ä»»åŠ¡ï¼Œé¿å…é¡µé¢å¡é¡¿ï¼›
const defer = typeof Promise === 'function' 
    ? Promise.prototype.then.bind(Promise.resolve())
    : setTimeout

// æ›´æ–°é˜Ÿåˆ—
const updateQueue: any[] = []

// é˜Ÿåˆ—æ›´æ–° API
export function enqueueRender(updater) {

    // å°†æ‰€æœ‰ updater åŒæ­¥æ¨å…¥æ›´æ–°é˜Ÿåˆ—ä¸­
    // ä¸ºå®ä¾‹æ·»åŠ ä¸€ä¸ªå±æ€§ __dirtyï¼Œæ ‡è¯†æ˜¯å¦å¤„äºå¾…æ›´æ–°çŠ¶æ€
    // åˆå§‹ å’Œ æ›´æ–°å®Œæ¯•ï¼Œè¯¥å€¼ä¼šè¢«ç½®ä¸º false
    // æ¨å…¥é˜Ÿåˆ—æ—¶ï¼Œæ ‡è®°ä¸º true
    if (
        !updater.__dirty && 
        (updater.__dirty = true) && 
        updateQueue.push(updater) === 1
    ) {
        // å¼‚æ­¥åŒ–å†²æ´—é˜Ÿåˆ—
        // æœ€ç»ˆåªæ‰§è¡Œä¸€æ¬¡å†²æ´—
        defer(flushRenderQueue)
    }
}

// åˆå¹¶ä¸€æ¬¡å¾ªç¯ä¸­å¤šæ¬¡ updater
function flushRenderQueue() {
    if (updateQueue.length) {
        // æ’åºæ›´æ–°é˜Ÿåˆ—
        updateQueue.sort()

        // å¾ªç¯é˜Ÿåˆ—å‡ºæ ˆ
        let curUpdater = updateQueue.pop()
        while (curUpdater) {
        
            // å½“ç»„ä»¶å¤„äº å¾…æ›´æ–°æ€ æ—¶ï¼Œè§¦å‘ç»„ä»¶æ›´æ–°
            // å¦‚æœè¯¥ç»„ä»¶å·²ç»è¢«æ›´æ–°å®Œæ¯•ï¼Œåˆ™è¯¥çŠ¶æ€ä¸º false
            // åˆ™åç»­çš„æ›´æ–°å‡ä¸å†æ‰§è¡Œ
            if (curUpdater.__dirty) {
                // è°ƒç”¨ç»„ä»¶è‡ªèº«çš„æ›´æ–°å‡½æ•°
                curUpdater.__update()

                // æ‰§è¡Œ callback
                flushCallback(curUpdater)
            }
            
            curUpdater = updateQueue.pop()
        }
    }
}

// æ‰§è¡Œç¼“å­˜åœ¨ updater.__setStateCallbacks ä¸Šçš„å›è°ƒ
function flushCallback(updater) {
    const callbacks = updater.__setStateCallbacks
    let cbk
    if (callbacks && callbacks.length) {
        while (cbk = callbacks.shift()) cbk.call(updater)
    }   
}
```

å®Œæˆè¿™ä¸ªæ–¹æ³•åï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹ä¸‹ä¸Šé¢çš„ `setState` å‡½æ•°: 

```js
class Component {
	// å…¶ä½™æ–¹æ³•
	...
	
	public setState(partialState = {}, callback?) {
        // åˆå¹¶çŠ¶æ€, æš‚å­˜äº å³å°†æ›´æ–°æ€ ä¸­
        // å¤„ç†å‚æ•°ä¸ºå‡½æ•°çš„å½¢å¼
        if (typeof partialState === 'function') {
            partialState = partialState(this.state, this.props)
        }
        
        this.__nextState = {
            ...this.state,
            ...partialState,
        }

        // ç¼“å­˜å›è°ƒ
        callback && this.__setStateCallbacks.push(callback)
        // æŠŠç»„ä»¶è‡ªèº«å…ˆæ¨å…¥æ›´æ–°é˜Ÿåˆ—
        enqueueUpdate(this)
	}
}
```

æ­¤æ—¶ï¼Œç”±äº **æ›´æ–°é˜Ÿåˆ—** ä¸ºå¼‚æ­¥çš„ï¼Œå› æ­¤å½“å¤šæ¬¡è¿ç»­è°ƒç”¨ `setState` æ—¶ï¼Œç»„ä»¶çš„çŠ¶æ€ä¼šè¢« **åŒæ­¥åˆå¹¶**ï¼Œå¾…å…¨éƒ¨å®Œæˆåï¼Œæ‰ä¼šè¿›å…¥æ›´æ–°é˜Ÿåˆ—çš„å†²æ´—å¹¶æœ€ç»ˆåªæ‰§è¡Œä¸€æ¬¡ç»„ä»¶æ›´æ–°ã€‚

React ä¸­ç»„ä»¶è¿˜æœ‰ä¸ªæ›´æ–°çš„æ–¹æ³•: `forceUpdate(callback)`ï¼Œè¯¥æ–¹æ³•çš„åŠŸèƒ½å…¶å®æ˜¯ä¸ `this.setState({}, callback)` ç›¸åŒçš„ï¼Œå”¯ä¸€æœ‰ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯: **è§¦å‘çš„æ›´æ–°ä¸éœ€è¦ç»è¿‡ `shouldComponentUpdate` çš„åˆ¤æ–­**ï¼Œå®ç°åªéœ€è¦åŠ ä¸ªæ ‡è¯†ä½å³å¯ã€‚

### ä¼˜åŒ–ç­–ç•¥

å›åˆ°æ€§èƒ½ä¼˜åŒ–è¿™ä¸ªç‚¹ï¼Œä»è¿™é‡Œçš„ç®€å•å®ç°æˆ‘ä»¬å¯ä»¥çœ‹å‡º: è™½ç„¶å¼‚æ­¥åŒ–äº†æ›´æ–°æµç¨‹ï¼Œä½†æœ¬è´¨ä¸Šä»ç„¶æ²¡æœ‰è§£å†³ å¤æ‚çš„ç»„ä»¶ `diff` å¸¦æ¥é•¿æ—¶é—´æ‰§è¡Œé˜»å¡ä¸»è¿›ç¨‹ã€‚æˆ‘è®°å¾—ä»¥å‰æ–‡ç« æœ‰è¯´è¿‡: **æœ€æœ‰æ•ˆçš„æ€§èƒ½ä¼˜åŒ–æ–¹å¼å°±æ˜¯ å¼‚æ­¥ã€ä»»åŠ¡åˆ†å‰² å’Œ ç¼“å­˜ç­–ç•¥ã€‚**

#### 1. å¼‚æ­¥åŒ–: 

é€šè¿‡æŠŠåŒæ­¥çš„ä»£ç æ‰§è¡Œå˜æˆå¼‚æ­¥ï¼ŒæŠŠä¸²è¡Œå˜æˆå¹¶è¡Œï¼Œå¯ä»¥æœ‰æ•ˆæé«˜ **æ‰§è¡Œçš„æ—¶é—´åˆ©ç”¨ç‡** å’Œ **ä¿è¯ä»£ç ä¼˜å…ˆçº§**ã€‚ä»è¿™é‡Œå¯ä»¥å»¶ä¼¸å‡ºä¸¤ç§ä¼˜åŒ–æ–¹å‘:

- 1. **å¼‚æ­¥**: å¦‚æˆ‘ä»¬ä¸Šé¢æ‰€åšçš„ä¼˜åŒ–ï¼Œè¿™æ ·èƒ½ä¿è¯ä¸»è¿›ç¨‹çš„æ‰§è¡Œä¼˜å…ˆçº§ï¼Œä¿è¯é¡µé¢æ¸²æŸ“æˆ–è€…æ›´ä¸»è¦ä»»åŠ¡çš„ä¼˜å…ˆæ‰§è¡Œï¼Œé¿å…å¡é¡¿ï¼›
- 2. **å¹¶è¡Œ**: é€šè¿‡æŠŠæŸäº›é«˜æ¶ˆè€—çš„æ“ä½œæ”¾åˆ° **éä¸»è¿›ç¨‹** ä¸Šæ‰§è¡Œï¼Œä¾‹å¦‚ worker çº¿ç¨‹ã€‚ä¸è¿‡ç”±äº `diff` æœ¬èº«å°±è¾ƒä¸ºå¤æ‚ï¼Œè¿˜è¦éœ€è¦å¤„ç†å¥½ä¸»è¿›ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ï¼Œä¼šå¯¼è‡´å¤æ‚åº¦æé«˜ï¼Œä½†ä¹Ÿå¹¶éä¸å¯è¡Œï¼Œåç»­ä¹Ÿè®¸æ˜¯ä¸ªä¼˜åŒ–æ–¹å‘ã€‚
	- ä¾‹å¦‚æˆ‘å°±åœ¨æ€è€ƒåœ¨è¿™é‡Œå¼•å…¥ wasm çš„å¯èƒ½æ€§ï¼Œä»£ä»·ä¸æ”¶ç›Šæ¯”å¦‚ä½•ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥ä¸€èµ·æ¢è®¨ã€‚  
	
#### 2. ä»»åŠ¡åˆ†å‰²

å°†åŸæœ¬ä¼šé˜»å¡ä¸»è¿›ç¨‹çš„ **å¤§å—é€»è¾‘æ‰§è¡Œè¿›è¡Œæ‹†è§£ï¼Œåˆ†å‰²æˆä¸€ä¸ªä¸ªå°ä»»åŠ¡**ã€‚ä»è€Œå¯ä»¥åœ¨é€»è¾‘ä¸­æ‰¾åˆ°åˆé€‚çš„æ—¶æœºç‚¹       **åˆ†æ®µæ‰§è¡Œ**ï¼Œå³ **ä¸ä¼šé˜»å¡ä¸»è¿›ç¨‹ï¼Œåˆå¯ä»¥è®©ä»£ç å¿«é€Ÿé«˜æ•ˆçš„æ‰§è¡Œï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç‰©ç†èµ„æºã€‚**

Facebook çš„å¤§ç¥ä»¬é€‰æ‹©äº†è¿™æ¡ä¼˜åŒ–æ–¹å‘ï¼Œè¿™å°±æ˜¯ React 16 æ–°å¼•å…¥çš„ `Fiber` ç†å¿µçš„æœ€ä¸»è¦ç›®çš„ã€‚ä¸Šé¢æˆ‘ä»¬å®ç°çš„ `diff` ä¸­ï¼Œæœ‰ç€ä¸€ä¸ªå¾ˆå¤§çš„éšœç¢: 

**ä¸€æ£µå®Œæ•´ è™šæ‹ŸDOMæ ‘ æ›´æ–°ï¼Œå¿…é¡»ä¸€æ¬¡æ€§æ›´æ–°å®Œæˆï¼Œä¸­é—´æ— æ³•è¢«æš‚åœï¼Œä¹Ÿæ— æ³•è¢«åˆ†å‰²ã€‚**

è€Œ `Fiber` æœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯ **æŒ‡é’ˆæ˜ å°„ï¼Œä¿å­˜ä¸Šä¸€ä¸ªæ›´æ–°çš„ç»„ä»¶ä¸ä¸‹ä¸€æ­¥éœ€è¦æ›´æ–°çš„ç»„ä»¶**ï¼Œä»è€Œå®Œæˆ **å¯æš‚åœå¯é‡å¯**ã€‚è®¡ç®—è¿›ç¨‹çš„è¿è¡Œæ—¶é—´ï¼Œåˆ©ç”¨æµè§ˆå™¨çš„ `requestIdleCallback` ä¸ `requestAnimationFrame` æ¥å£ï¼Œå½“æœ‰ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡æ—¶ï¼Œä¼˜å…ˆæ‰§è¡Œï¼Œæš‚åœä¸‹ä¸€ä¸ªç»„ä»¶çš„æ›´æ–°ã€‚å¾…ç©ºé—²æ—¶å†é‡å¯æ›´æ–°ã€‚

`Fiber` ç®—æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œåœ¨å…¶å®ƒè¯­è¨€ä¸­ä¹Ÿæœ‰è®¸å¤šåº”ç”¨(`Ruby Fiber`)ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯:

**ä»»åŠ¡æ‹†åˆ†å’ŒååŒï¼Œä¸»åŠ¨æŠŠæ‰§è¡Œæƒäº¤ç»™ä¸»çº¿ç¨‹ï¼Œä½¿ä¸»çº¿ç¨‹æœ‰æ—¶é—´ç©ºæŒ¡å¤„ç†å…¶ä»–é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚**

ä½†å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼Œä¸ºäº†æœ¬æ–‡ä¾¿äºç†è§£ï¼Œæš‚æ—¶å¹¶æ²¡æœ‰å¼•å…¥ã€‚ç­‰ä»¥åæœ‰æœºä¼šæˆ‘ä»¬å†æ¥ä¸€èµ·æ·±æŒ– `Fiber` çš„å®ç°ï¼Œä¹Ÿè®¸èƒ½æˆä¸ºæ›´å¤šä½¿ç”¨åœºæ™¯çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚

### å­ç»„ä»¶æ›´æ–°

åœ¨ä¸Šç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼˜å…ˆå®ç°äº† `diffVNode` æ–¹æ³•ç”¨äºæ›´æ–° **å…ƒç´ èŠ‚ç‚¹**ï¼Œä½†ç»„ä»¶èŠ‚ç‚¹çš„æ›´æ–°ä¸å…ƒç´ èŠ‚ç‚¹çš„æ›´æ–°æ˜¯ä¸åŒçš„ã€‚å½“å‡ºç°ç»„ä»¶åµŒå¥—çš„æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªæ–°çš„æ–¹æ³•(`diffComponent`)ç”¨äºç»„ä»¶èŠ‚ç‚¹çš„æ›´æ–°ã€‚

ä¸ **å…ƒç´ èŠ‚ç‚¹** ä¸åŒï¼Œç»„ä»¶èŠ‚ç‚¹ä¹‹é—´çš„æ›´æ–°é‡è¦çš„æ˜¯é‡æ¸²æŸ“ï¼Œç±»ä¼¼äºæˆ‘ä»¬ä¸Šé¢çš„ `setState`ã€‚

**å¤ç”¨å·²åˆ›å»ºå¥½çš„ç»„ä»¶å®ä¾‹ï¼Œæ ¹æ®æ–°çš„ çŠ¶æ€(`state`)ä¸ å±æ€§(`props`) é‡æ–°æ‰§è¡Œ `render` ç”Ÿæˆ å…ƒç´ èŠ‚ç‚¹ï¼Œå†é€’å½’æ¯”å¯¹**ï¼Œ

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `diffVNode` å¤–å›´å†åšä¸€å±‚åˆ¤æ–­å¤„ç†:

```js
function diff(oldVNode, newVNode) {
	if (isSameVNode(oldVNode, newVNode)) {
        if (typeof oldVNode.type === 'function') {
            // ç»„ä»¶èŠ‚ç‚¹
            diffComponent(oldVNode, newVNode)
        } else {
            // å…ƒç´ èŠ‚ç‚¹ï¼Œ
            // ç›´æ¥æ‰§è¡Œæ¯”å¯¹
            diffVNode(oldVNode, newVNode)
        }
	} else {
		// æ–°èŠ‚ç‚¹æ›¿æ¢æ—§èŠ‚ç‚¹
		...
	}
}


// ç»„ä»¶æ¯”å¯¹
function diffComponent(oldCompVNode, newCompVNode) {
    const { instance, vnode: oldVNode, elm } = oldCompVNode
    const { props: nextProps } = newCompVNode

    if (instance && oldVNode) {
        instance.__dirty = false
        
        // æ›´æ–°çŠ¶æ€å’Œå±æ€§
        instance.__nextProps = nextProps
        if (!instance.__nextState) instance.__nextState = instance.state
        
        // å¤ç”¨æ—§ç»„ä»¶å®ä¾‹å’Œå…ƒç´ 
        newCompVNode.instance = instance
        newCompVNode.elm = elm

        // ä½¿ç”¨æ–°å±æ€§ã€æ–°çŠ¶æ€ï¼Œæ—§ç»„ä»¶å®ä¾‹
        // é‡æ–°ç”Ÿæˆ æ–°è™šæ‹ŸDOM
        const newVNode = initComponent(newCompVNode)
        
        // é€’å½’è§¦å‘ diff
        diff(oldVNode, newVNode)
    }
}
```

## ç¬¬ä¹ç«™: ç”Ÿå‘½ä¹‹æ³‰ - Lifecycle

ç»„ä»¶æœ‰ä¸€ä¸ªç›¸å½“é‡è¦çš„ç‰¹å¾ï¼Œä¾¿æ˜¯å…·æœ‰ **ç”Ÿå‘½å‘¨æœŸ**ã€‚ä¸åŒçš„å‡½æ•°é’©å­å¯¹åº”äº†ç»„ä»¶ **ä»åˆå§‹åŒ–åˆ°é”€æ¯** çš„å„ä¸ªå…³é”®æ—¶é—´ç‚¹ã€‚ä¸»è¦æ˜¯ä¸ºäº†è®©ä¸šåŠ¡æ–¹æœ‰èƒ½åŠ› **æ’å…¥ç»„ä»¶çš„æ¸²æŸ“å·¥ä½œæµ** ä¸­ï¼Œç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚æˆ‘ä»¬å…ˆæ¥ç®€å•æ¢³ç†ä¸‹æœ€æ–° React ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ:

### **é¦–æ¬¡æ¸²æŸ“**:

- **`constructor`**

	- å³ç»„ä»¶çš„ **å®ä¾‹åŒ–æ—¶æœº**ï¼Œé€šå¸¸å¯ä»¥ç”¨æ¥è®¾ç½®åˆå§‹åŒ– `state`ï¼›
	
- **`static getDerivedStateFromProps(nextProps, prevState)`**

	- åœ¨ç»„ä»¶çš„æ¨¡æ¿æ¸²æŸ“ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„æ•°æ®ä¸º `state` å’Œ `props`ï¼Œè€Œ `props` ç”±çˆ¶çº§ä¼ å…¥ï¼Œç»„ä»¶æœ¬èº«å¹¶æ— æ³•ç›´æ¥ä¿®æ”¹ï¼Œå› æ­¤å”¯ä¸€çš„å¸¸è§éœ€æ±‚å°±æ˜¯: **æ ¹æ®çˆ¶çº§ä¼ å…¥çš„ `props` åŠ¨æ€ä¿®æ”¹ `state`**ã€‚è¯¥ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ä¸ºæ­¤è€Œç”Ÿï¼›
	
	- å¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®: **è¯¥æ–¹æ³•ä¸ºä»€ä¹ˆä¸ºé™æ€æ–¹æ³•? è€Œä¸æ˜¯å¸¸è§„çš„å®ä¾‹æ–¹æ³•å‘¢ï¼Ÿ**
	
		- å…ˆè‚¯å®šä¸€ç‚¹: **ä½¿ç”¨å®ä¾‹æ–¹æ³•è‚¯å®šä¹Ÿæ˜¯èƒ½æ»¡è¶³éœ€æ±‚çš„**ã€‚ä½†è¿™ä¸ªé’©å­æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºæ˜¯ä½äº **æ–°çŠ¶æ€åˆå¹¶ä¹‹åï¼Œé‡æ¸²æŸ“ä¹‹å‰**ï¼Œè€Œä¸”è¯¥æ–¹æ³•ä¼š **ä¾µå…¥æ›´æ–°æœºåˆ¶** ä¸­ã€‚å¦‚æœåœ¨ä¹‹ä¸­åšä¾‹å¦‚ä¿®æ”¹çŠ¶æ€ä¹‹ç±»çš„æ“ä½œæ˜¯ååˆ†ä¸å¯æ§çš„ã€‚å½“è®¾è®¡ä¸ºé™æ€æ–¹æ³•åï¼Œå‡½æ•°å†…éƒ¨ä¾¿æ— æ³•è®¿é—®ç»„ä»¶å®ä¾‹ï¼Œæˆä¸ºä¸€ä¸ª **çº¯å‡½æ•°**ï¼Œä¾¿èƒ½ä¿è¯æ›´æ–°æµç¨‹çš„å®‰å…¨ä¸ç¨³å®šã€‚
		
- **`render()`**

	- æ ¹æ® `state` å’Œ `props`ï¼Œç”Ÿæˆ **è™šæ‹ŸDOM**ï¼›
	
- **`componentDidMount()`**

	- **ç»„ä»¶è¢«åˆ›å»ºæˆçœŸå®å…ƒç´ å¹¶æ¸²æŸ“å** è¢«è°ƒç”¨ï¼Œæ­¤æ—¶å¯è·å–çœŸå®çš„å…ƒç´ çŠ¶æ€ï¼Œä¸»è¦ç”¨äºä¸šåŠ¡é€»è¾‘çš„æ‰§è¡Œï¼Œä¾‹å¦‚æ•°æ®è¯·æ±‚ï¼Œäº‹ä»¶ç»‘å®šç­‰ï¼›

### **æ›´æ–°é˜¶æ®µ**:

- **`static getDerivedStateFromProps(nextProps, prevState)`**

- **`shouldComponentUpdate(nextProps, nextState)`**

	- ä¸Šç¯‡æ–‡ç« ä¸­çš„ `diff` ä¼˜åŒ–ç­–ç•¥ä¸­æœ‰æåˆ°: ä¸ºäº†å‡å°‘ **æ— è°“çš„æ›´æ–°æ¶ˆè€—**ï¼Œèµ‹äºˆç»„ä»¶ä¸€ä¸ªå¯ä»¥ **ä¸»åŠ¨ä¸­æ–­æ›´æ–°æµ** çš„ `API`ã€‚æ ¹æ®å‚æ•°ä¸­çš„ **æ›´æ–°å±æ€§** å’Œ **æ›´æ–°çŠ¶æ€**ï¼Œä¸šåŠ¡æ–¹è‡ªè¡Œåˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­å¾€ä¸‹æ‰§è¡Œ `diff`ï¼Œä»è€Œèƒ½æœ‰æ•ˆåœ°æå‡ **æ›´æ–°æ€§èƒ½**ï¼›
	
	- å¤§å®¶è®°å¾— React ä¸­æœ‰ç§ç»„ä»¶å« **çº¯ç»„ä»¶(`PureComponent`)** å§ï¼Œå…¶å®è¿™ä¸ªç±»ç»§æ‰¿äºæ™®é€šçš„ `Component` ä¸Šå°è£…çš„ï¼Œå¯ä»¥å‡å°‘å¤šä½™çš„ `render`ï¼Œæå‡æ€§èƒ½ã€‚

		- é»˜è®¤ä½¿ç”¨ `shouldComponentUpdate` å‡½æ•°è®¾å®šæ›´æ–°æ¡ä»¶: **ä»…å½“ `props` å’Œ `state` å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰ä¼šè§¦å‘æ›´æ–°**ã€‚è¿™é‡Œä½¿ç”¨äº† `Object` æµ…å±‚æ¯”å¯¹ï¼Œä¹Ÿå°±æ˜¯ä»…åšç¬¬ä¸€å±‚æ¯”å¯¹ï¼Œå³ **1. key æ˜¯å¦å®Œå…¨åŒ¹é…ï¼›2. value æ˜¯å¦å…¨ç­‰ï¼›** æ‰€ä»¥å¦‚æœéœ€è¦è¶…è¿‡ä¸€å±‚çš„æ•°æ®å˜åŠ¨ï¼Œçº¯ç»„ä»¶å³æ— æ³•æ­£ç¡®æ›´æ–°äº†ï¼›
		
		- è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ React æå€¡ä½¿ç”¨ **ä¸å˜æ•°æ®** çš„åŸç†ï¼Œèƒ½æœ‰æ•ˆåœ°ä½¿ç”¨æµ…å±‚æ¯”å¯¹ï¼›

		- **ä¸å˜æ•°æ®**: æå€¡æ•°æ®ä¸å¯å˜ï¼Œä»»ä½•ä¿®æ”¹éƒ½éœ€è¦è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡ï¼Œè¿™æ ·èƒ½æœ‰æ•ˆæé«˜æ¯”å¯¹æ•ˆç‡ï¼Œå‡å°‘æ— è°“æ€§èƒ½æŸè€—ã€‚
		
- **`render()`**

- **`getSnapshotBeforeUpdate(prevProps, prevState)`**

	- æ›¿æ¢æ—§ç‰ˆçš„ `componentWillUpdate`ï¼Œè§¦å‘æ—¶æœºç‚¹: åœ¨æ•°æ®çŠ¶æ€å·²æ›´æ–°ï¼Œæœ€æ–° `VNode` å·²ç”Ÿæˆï¼Œä½† **çœŸå®å…ƒç´ è¿˜æœªè¢«æ›´æ–°**ï¼›
	
	- å¯ä»¥ç”¨æ¥åœ¨ **æ›´æ–°ä¹‹å‰** ä»çœŸå®å…ƒç´ æˆ–çŠ¶æ€ä¸­è·å–è®¡ç®—ä¸€äº›ä¿¡æ¯ï¼Œä¾¿äºåœ¨æ›´æ–°åä½¿ç”¨ï¼›
	
- **`componentDidUpdate(prevProps, prevState, snapshot)`**

	- ç»„ä»¶æ›´æ–°å®Œæˆåè°ƒç”¨ï¼›
	
	- å¯ä»¥ç”¨äº **ç›‘å¬æ•°æ®å˜åŒ–**ï¼Œä½¿ç”¨ `setState` æ—¶å¿…é¡»åŠ æ¡ä»¶ï¼Œé¿å…æ— é™å¾ªç¯ï¼›

### **å¸è½½é˜¶æ®µ**:

- **`componentWillUnmount()`**
	- ç»„ä»¶å³å°†è¢«é”€æ¯ã€‚é€šå¸¸å¯ä»¥ç”¨äº **è§£ç»‘äº‹ä»¶**ã€**æ¸…é™¤æ•°æ®**ã€**é‡Šæ”¾å†…å­˜** ç­‰åŠŸèƒ½ï¼› 

æˆ‘ä»¬ä¹ŸæŒ‰è¿™æ ·çš„ç›®æ ‡æ¥åœ¨æˆ‘ä»¬çš„ `Component` ä¸Šå®ç°è¿™äº›ç”Ÿå‘½å‘¨æœŸï¼Œé‚£å¦‚ä½•æ›´å¥½çš„ç»„ç»‡ç”Ÿå‘½å‘¨æœŸå‘¢ï¼Ÿè¿™é‡Œæˆ‘è€ƒè™‘åˆ°çš„æ˜¯: 

**ç»„ä»¶ä½œä¸ºå…ƒç´ çš„å®¹å™¨ï¼Œç”Ÿå‘½å‘¨æœŸçš„æœ¬è´¨å…¶å®æ˜¯ å…¶æ¸²æŸ“å‡ºçš„å…ƒç´ èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸ**ã€‚
	
ä¹Ÿå°±æ˜¯è¯´ï¼Œå…³é”®ç‚¹è¿˜æ˜¯åœ¨äº **å…ƒç´ åœ¨è§†å›¾ä¸­çš„å·¥ä½œæµï¼Œä½•æ—¶è¢«æŒ‚è½½ - æ›´æ–° - å¸è½½**ã€‚æ‰€ä»¥ä¸ºäº†æ›´å¥½çš„ç»´æŠ¤æ€§å’Œæ‹“å±•æ€§ï¼Œæ›´ç†æƒ³çš„æ–¹å¼åº”è¯¥æ˜¯ **ä¸ºå…ƒç´ èŠ‚ç‚¹ç»Ÿä¸€æ·»åŠ ç”Ÿå‘½å‘¨æœŸ**ï¼Œè€Œä¸æ˜¯å•ç‹¬ä¸ºç»„ä»¶ï¼Œè¿™æ ·å¯å¤§å¤§é™ä½å¤æ‚åº¦ï¼Œå¢åŠ å¯æ‹“å±•æ€§ã€‚

### èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸ

é‚£æˆ‘ä»¬ç¬¬ä¸€æ­¥å…ˆæ ¹æ®ä¸Šé¢éœ€è¦çš„ç”Ÿå‘½å‘¨æœŸæ¥ç†ä¸€ä¸‹éœ€è¦å“ªäº›æ—¶æœº:

- **åˆ›å»ºå(`create`)**ï¼›
- **æŒ‚è½½å(`insert`)**ï¼›
- **æ›´æ–°å‰(`willupdate`)**ï¼›
- **æ›´æ–°å(`update`)**ï¼›
- **åˆ é™¤å‰(`willremove`)**ï¼›

åŸç†å°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦åœ¨ `VNode` å·¥ä½œæµä¸­çš„å¯¹åº”æ—¶æœŸè°ƒç”¨ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°å³å¯ã€‚é‚£æˆ‘ä»¬ç°åœ¨ `VNode` ä¸Šæ–°å¢ä¸€ä¸ªå±æ€§ `hooks`ï¼Œç”¨äº **å‚¨å­˜** å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°:

```js
interface VNode {
	...
	
	hooks: {
        create?: (vnode) => void
        insert?: (vnode) => void
        willupdate?: (oldVNode, newVNode) => void
        update?: (oldVNode, newVNode) => void
        willremove?: (vnode) => void
    }
}
```

æ–°å¢ä¸€ä¸ªè§¦å‘çš„æ–¹æ³•(`fireVNodeHook`):

```js
function fireVNodeHook(vnode, name, ...data) {
    // æ ¹æ® ç”Ÿå‘½å‘¨æœŸåç§°
    // æ‰§è¡Œå‚¨å­˜åœ¨ VNode ä¸Šçš„å¯¹åº”å‡½æ•°å³å¯
    const { hooks: _hooks } = vnode
    if (_hooks) {
        hook = _hooks[name]
        hook && hook(...data)
    }
}
```

æœ‰äº†è¿™å±‚åŸºç¡€æ–¹æ³•åï¼Œæˆ‘ä»¬åªéœ€è¦åˆ†åˆ«åœ¨ä¹‹å‰æ‰€å†™çš„ **æ¸²æŸ“ä¸æ›´æ–°** æµç¨‹ä¸­çš„å„ä¸ªå‡½æ•°é€‚æ—¶åœ°è§¦å‘å°±è¡Œäº†ã€‚

#### 1. `create`

è¯¥æ—¶æœºæ˜¯åœ¨ **å…ƒç´ è¢«åˆ›å»ºåï¼Œä½†è¿˜æœªè¢«æŒ‚è½½ä¹‹å‰**ã€‚ç”±äºæˆ‘ä»¬ä¹‹å‰å°†é€»è¾‘ç»Ÿä¸€æ”¶å½’ä¸º `createElm`ï¼Œå› æ­¤åªéœ€è¦åœ¨è¯¥å‡½æ•°æœ«å°¾ç»Ÿä¸€åŠ å…¥è§¦å‘å³å¯ã€‚

```js
function createElm(vnode) {
	// åˆ›å»ºå…ƒç´ é€»è¾‘
	...
	
	// è§¦å‘ è™šæ‹ŸDOM ä¸Šå‚¨å­˜çš„ é’©å­å‡½æ•°
	fireVNodeHook(vnode, 'create', vnode)
	
	return vnode.elm
}
```

#### 2. `insert`

**å…ƒç´ è¢«æŒ‚è½½åˆ°è§†å›¾** ä¸Šçš„æ—¶æœºã€‚ä»å…ƒç´ çš„è§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯è¢« `append` åˆ°çˆ¶çº§ä¸­çš„æ—¶æœºç‚¹ã€‚è¿™ä¸ªæ—¶æœºç‚¹æ¯”è¾ƒåˆ†æ•£ï¼Œä½†ä¹Ÿæ¯”è¾ƒå¥½åŠ å…¥ï¼Œæ‰¾åˆ°æˆ‘ä»¬ä½¿ç”¨ `Api` ä¸­çš„ `append` æ–¹æ³•åŠ å…¥ï¼Œæ€»å…±æœ‰ä¸‰ä¸ªåœ°æ–¹:

- `render` å‡½æ•°ä¸­åŠ å…¥å¯¹ **æ ¹èŠ‚ç‚¹** çš„è§¦å‘ï¼›
- `createElm` å‡½æ•°ä¸­åŠ å…¥å¯¹ **æ‰€æœ‰å­çº§** çš„è§¦å‘ï¼›
- `diffChildren` åˆ—è¡¨æ¯”å¯¹ä¸­ **æ–°å¢åˆ—è¡¨é¡¹** çš„è§¦å‘ï¼›

#### 3. `willupdate` ä¸ `update`

**æ›´æ–°ä¹‹å‰** ä¸ **æ›´æ–°ä¹‹å**ï¼Œå¯¹åº”çš„ä¾¿æ˜¯æˆ‘ä»¬çš„ `diff` å‡½æ•°ã€‚ç”±äºæœ€ç»ˆå‡éœ€èµ°åˆ° `diffVNode` ä¸­ï¼Œå› æ­¤åªéœ€è¦åœ¨ `diffVNode` å¼€å¤´å’Œæœ«å°¾è§¦å‘å³å¯ã€‚

#### 4. `willremove`

**å…ƒç´ è¢«å¸è½½æ—¶**ï¼Œå…¶å®ä¸ `insert` ç±»ä¼¼ï¼Œåªéœ€è¦å…³æ³¨ `Api` ä¸­ `removeChild` çš„è°ƒç”¨æ—¶æœºå³å¯ã€‚åœ¨ `diff` åˆ—è¡¨æ¯”å¯¹æœŸé—´ï¼Œå½“æ–°åˆ—è¡¨ä¸­ä¸å­˜åœ¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æ—§åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰å†™çš„ä¸šåŠ¡å‡½æ•° `removeVNodes`ã€‚

### ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ

ç”±äº **å…ƒç´ èŠ‚ç‚¹** æ‰æ˜¯è´¯ç©¿æ•´æ£µ **è™šæ‹ŸDOM** æ¸²æŸ“ä¸æ›´æ–°çš„å…³é”®ï¼Œå› æ­¤æˆ‘ä»¬ä¸Šé¢å…ˆå®ç°çš„æ˜¯å¯¹ **å…ƒç´ èŠ‚ç‚¹** çš„ç”Ÿå‘½å‘¨æœŸè§¦å‘ã€‚ä½†æ˜¯æˆ‘ä»¬æœ€ç»ˆéœ€è¦æ˜¯ **ç»„ä»¶èŠ‚ç‚¹** çš„ç”Ÿå‘½å‘¨æœŸã€‚ç”±äº **ç»„ä»¶èŠ‚ç‚¹** ä¸ **å…ƒç´ èŠ‚ç‚¹** ä¸ºä¸€ä¸€å¯¹åº”çš„ **ä¸Šä¸‹å±‚çº§å…³ç³»**ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦åšä¸€å±‚è½¬æ¥: 

**æŠŠç»„ä»¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸèµ‹å€¼ç»™å…¶ç”Ÿæˆçš„å…ƒç´ èŠ‚ç‚¹**ã€‚

é¦–å…ˆæˆ‘ä»¬å…ˆæ¥ä¸ºç»„ä»¶å®šä¹‰ä¸Šç”Ÿå‘½å‘¨æœŸï¼Œå¹¶å®šä¹‰ä¸€ä¸ªä¸­è½¬å¯¹è±¡ `__hooks`ï¼Œå®ç° **ç»„ä»¶èŠ‚ç‚¹å‘¨æœŸä¸å…ƒç´ èŠ‚ç‚¹å‘¨æœŸçš„è½¬æ¢**:

```js
class Component {
    public __hooks = {
        // å…ƒç´ èŠ‚ç‚¹ æ’å…¥æ—¶æœºï¼Œè§¦å‘ didMount
        insert: () => this.componentDidMount(),

        // å…ƒç´ èŠ‚ç‚¹ æ›´æ–°ä¹‹å‰ï¼Œè§¦å‘ getSnapshotBeforeUpdate
        willupdate: (vnode) => {
            this.__snapshot = this.getSnapshotBeforeUpdate(this.__prevProps, this.__prevState)
        },

        // å…ƒç´ èŠ‚ç‚¹ æ›´æ–°ä¹‹åï¼Œ è§¦å‘ didUpdate
        update: (oldVNode, vnode) => {
            this.componentDidUpdate(this.__prevProps, this.__prevState, this.__snapshot)
            this.__snapshot = undefined
        },

        // å…ƒç´ èŠ‚ç‚¹ å¸è½½ä¹‹å‰ï¼Œ è§¦å‘ willUnmount
        willremove: (vnode) => this.componentWillUnmount(),
    }

    // é»˜è®¤ç”Ÿå‘½å‘¨æœŸå‡½æ•°	
    // getDerivedStateFromProps(nextProps, state)
    public getSnapshotBeforeUpdate(prevProps, prevState) { return undefined }
    public shouldComponentUpdate(nextProps, nextState) { return true }
    public componentDidMount() { }
    public componentDidUpdate(prevProps, prevState, snapshot) { }
    public componentWillUnmount() { }
}
```

ç„¶åæˆ‘ä»¬åªéœ€è¦åœ¨ `__createVNode` æ–¹æ³•ä¸­å°† `this.__hooks` èµ‹å€¼ç»™ç”Ÿæˆå‡ºçš„ `VNode` å³å¯:

```js
class Component {
	...
	
	public __createVNode() {
	    // ...
	    this.__vnode = this.render()
	    
	    // èµ‹å€¼ç»™å¯¹åº”çš„ å…ƒç´ èŠ‚ç‚¹ï¼Œ
	    // å®ç°è¯¥ å…ƒç´ èŠ‚ç‚¹ ä¸ ç»„ä»¶ ä¹‹é—´ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®š
	    this.__vnode.hooks = this.__hooks
	    
	    return this.__vnode
	}
}
```

æœ€åï¼Œå¤§å®¶å¯èƒ½å‘ç°æˆ‘ä»¬è¿˜æœ‰ä¸¤ä¸ªé’©å­æ²¡æœ‰å®ç°: `getDerivedStateFromProps` å’Œ `shouldComponentUpdate`ï¼Œè¿™æ˜¯å› ä¸ºè¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸä¼šå½±å“åˆ°æ›´æ–°ç»“æœï¼Œå› æ­¤éœ€è¦ **æ·±å…¥åˆ°æ›´æ–°æµç¨‹ä¸­**ï¼Œæ— æ³•å•çº¯çš„é€šè¿‡ **å…ƒç´ èŠ‚ç‚¹** çš„ç”Ÿå‘½å‘¨æœŸæ¥å®ç°ã€‚

ä½†å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ **æ›´æ–°ä¹‹å‰**ï¼Œéœ€è¦æ ¹æ®è¿™ä¸¤ä¸ªå‡½æ•°çš„è¿”å›ç»“æœï¼Œé€‚å½“è°ƒæ•´ä¸‹æ›´æ–°é€»è¾‘å³å¯:

```js
// Componet ä¸­çš„ __update æ–¹æ³•
class Component {
	// ...

	public __update = () => {
        // ä¸´æ—¶å­˜å‚¨ æ—§è™šæ‹ŸèŠ‚ç‚¹ (oldVNode)
        const oldVNode = this.__vnode
        
        this.__nextProps = this.props
        if (!this.__nextState) this.__nextState = this.state
        
        // æ‰§è¡Œ getDerivedStateFromProps
        // æ›´æ–° state çŠ¶æ€
        const cls = this.constructor
        if (cls.getDerivedStateFromProps) {
            const state = cls.getDerivedStateFromProps(this.__nextProps, this.state)
            if (state) {
                this.__nextState = Object.assign(this.__nextState, state)
            }
        }
        
        // åœ¨ diff ä¹‹å‰è°ƒç”¨ shouldComponentUpdate è¿›è¡Œåˆ¤æ–­
        // true: ç”Ÿæˆæ–° VNodeï¼Œç»§ç»­ diff
        // false: æ¸…ç©ºçŠ¶æ€
        if (this.shouldComponentUpdate(this.props, this.__nextState)) {
            // é‡æ–°ç”Ÿæˆ æ–°è™šæ‹ŸèŠ‚ç‚¹(newVNode)
            this.__vnode = this.__createVNode()

            // è°ƒç”¨ diffï¼Œæ›´æ–° VNode
            diff(oldVNode, this.__vnode)
        } else {
            // æ¸…ç©ºçŠ¶æ€æ›´æ–°
            this.__nextProps = this.__nextState = undefined
        }
        
        // åˆšæ‰ å¼‚æ­¥æ›´æ–°é˜Ÿåˆ— ä¸­æ ‡è¯†çš„ç»„ä»¶ å¾…æ›´æ–°çŠ¶æ€
        // åœ¨æ›´æ–°å®Œåç½®ä¸º false
        this.__dirty = false
	}
}
```

ç»„ä»¶æ›´æ–°è¿˜æœ‰å¦å¤–ä¸€ä¸ªåœ°æ–¹ï¼Œå³ `diffComponent`ï¼Œä¹Ÿéœ€è¦åŠ å…¥ä¸Šè¿°ç±»ä¼¼çš„æ‰§è¡Œå’Œåˆ¤æ–­ã€‚å®Œæˆè¿™éƒ¨åˆ†ä»£ç åï¼Œæˆ‘ä»¬æ¥ç®€å•æµ‹è¯•ä¸ª DEMO:

- 1. `<App>`ã€`<BBB txt={this.state.txt} />` **æ­£ç¡®æ¸²æŸ“**ï¼›
- 2. åŒç»„ä»¶ **æ¸²æŸ“ç”Ÿå‘½å‘¨æœŸ** ä¸é¢„æœŸä¸€è‡´ï¼›
- 3. **è§¦å‘æ›´æ–°**ï¼Œè°ƒç”¨ `<App> setState`ï¼Œ`<BBB>` æ–‡å­—å…ƒç´ æ­£ç¡®æ›´æ–°ï¼›
- 4. åŒç»„ä»¶ **æ›´æ–°ç”Ÿå‘½å‘¨æœŸ** ä¸é¢„æœŸä¸€è‡´ï¼›

![](https://user-gold-cdn.xitu.io/2020/3/24/1710a381f500d6d3?w=550&h=417&f=gif&s=4875150)

<p style="text-align: center;font-weight: bold;">å›¾1. ç”Ÿå‘½å‘¨æœŸæ¼”ç¤ºDEMO</p>

## æœ€åä¸€ç«™: æ—…é€”ä¹‹æœ«

åœ¨è¿™ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å®ç°äº† React æœ€æ ¸å¿ƒçš„éƒ¨åˆ†: **JSXã€ç»„ä»¶ã€æ¸²æŸ“ã€æ›´æ–°**ã€‚æˆ‘ä»¬åŸºäº **åŠ¨æ‰‹å®è·µ** çš„æ–¹å¼ï¼Œå¾ªåºæ¸è¿›åœ°æ¢è®¨äº†ä¸€äº›åŸç†ä¸ç­–ç•¥ï¼Œå¾—å‡ºä¸€äº›æœ€ä½³å®è·µã€‚ç›¸ä¿¡èµ°å®Œè¿™éæ—…ç¨‹åï¼Œå¤§å®¶èƒ½å¯¹ React æœ‰äº†æ›´æ·±å±‚æ¬¡çš„äº†è§£ï¼Œèƒ½å¤Ÿç»™åˆ°å„ä½å°ä¼™ä¼´å¯å‘ä¸å¸®åŠ©ã€‚å…¶å®æˆ‘ä¹Ÿä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ—…ç¨‹ä¸­è·Ÿå¤§å®¶ä¸€èµ·å…±åŒå­¦ä¹ ï¼Œå…±åŒæˆé•¿ã€‚

**[React å®è·µæ­ç§˜ä¹‹æ—…ï¼Œä¸­é«˜çº§å‰ç«¯å¿…å¤‡(ä¸Š) ->](https://github.com/xd-tayde/blog/blob/master/ReactGL-1.md)**

è¿˜æœ‰è®¸å¤šæ¨¡å—ï¼Œå¦‚ `Context`ã€`Refs`ã€`Fragment` å’Œ ä¸€äº›å…¨å±€APIï¼Œå¦‚ `cloneElement` ç­‰ï¼Œè¿˜æœ‰ä»£ç ä¸­ä¸€äº›æ›´ä¸¥è°¨çš„åˆ¤æ–­åŠè¾¹ç•Œæƒ…å†µçš„å¤„ç†ï¼Œå¹¶æ²¡æœ‰åœ¨æ–‡ç« ä¸­ä½“ç°ï¼Œä¸»è¦æ˜¯ç”±äºè¿™äº›éƒ¨åˆ†æ›´å¤šçš„æ˜¯çº¯é€»è¾‘çš„æ‰©å±•ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†ä¾¿äºç†è§£ã€‚å¦‚æœç«¥é‹ä»¬æœ‰å…´è¶£ï¼Œå¯ä»¥åˆ° github ä¸­æŸ¥çœ‹å®Œæ•´ç‰ˆä»£ç :

**[react-webgl.js ->](https://github.com/xd-tayde/react-webgl.js)**

å¦å¤–æˆ‘ä¹Ÿæƒ³ç¨å¾®å” å—‘ä¸‹å…³äº React-WebGL è¿™ä¸ªæƒ³æ³•ã€‚

è¿‘é˜¶æ®µæˆ‘æ¥è§¦äº†ä¸€äº› Web æ¸¸æˆçš„å¼€å‘ï¼Œæœ‰äº†ä¸€äº›ä»å‰ç«¯å¼€å‘è€…å‡ºå‘çš„æ€è€ƒä¸ç†è§£ã€‚åœ¨æ¸¸æˆå¼€å‘é¢†åŸŸï¼Œä¼ ç»Ÿçš„æ¸¸æˆå¼€å‘è€…æœ‰ç€ä¸€å¥—ä¸å‰ç«¯é¢†åŸŸå®Œå…¨ä¸åŒçš„æ€ç»´ç¼–ç¨‹æ¨¡å¼ã€‚éšç€ Web çš„å‘å±•ï¼Œä½¿ä»–ä»¬éœ€è¦æ‹“å±•åˆ° Js çš„ç¯å¢ƒä¸­ã€‚æ‰€ä»¥å‡ºç°äº†ä¸€ç³»åˆ—çš„æ¸¸æˆå¼•æ“åº“ï¼Œæœ¬è´¨ä¸Šæ˜¯ä»å…¶å®ƒå¹³å°çš„åº“ç§»æ¤è¿‡æ¥çš„ã€‚å½“æˆ‘ä»ä¸€ä¸ªå‰ç«¯å¼€å‘è€…çš„è§’åº¦åœ¨è¿›è¡Œå¼€å‘æ—¶ï¼Œå…¶å®å¹¶ä¸æ˜¯è¯´å…¥é—¨éš¾ï¼Œå­¦ä¹ æˆæœ¬é«˜ï¼Œè€Œæ˜¯ç»™æˆ‘çš„æ„Ÿè§‰æ˜¯: ç±»ä¼¼ç”¨çº¯åŸç”Ÿ js åœ¨å†™é¡µé¢ï¼Œè§‰å¾—æ•ˆç‡ä½ä¸‹ã€‚æ‰€ä»¥è¿™ä¹Ÿæ˜¯ React-WebGL çš„å‡ºå‘ç‚¹ï¼ŒæœŸæœ›èƒ½å°†ç°åœ¨ Web ä¸­æ›´ä¼˜ç§€çš„ç†å¿µè¿ç”¨åˆ°æ¸¸æˆå¼€å‘ï¼Œç”šè‡³æ‰¾åˆ°ä¸€ç§æ›´é«˜æ•ˆçš„å¼€å‘æ¨¡å¼ï¼Œæå‡æ•ˆç‡ï¼Œå®Œå–„ç”Ÿæ€ã€‚

å½“ç„¶ï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªèµ·ç‚¹ï¼Œ æ¸¸æˆå¼€å‘ ä¸ ç•Œé¢å¼€å‘ ç¡®å®æœ‰ç€è®¸å¤šå¼‚åŒç‚¹ï¼Œ**å¦‚ä½•æ‰¾åˆ°ä¸€ç§æ›´ç°ä»£åŒ–æ›´é«˜æ•ˆçš„ Web æ¸¸æˆå¼€å‘æ¨¡å¼**ï¼Œè¿™è¿˜éœ€è¦å¾ˆé•¿çš„ä¸€æ®µæ—…ç¨‹ã€‚æˆ‘ä¹Ÿä¸€ç›´åœ¨æ€è€ƒï¼Œä¸€ç›´åœ¨æ‘¸ç´¢ï¼Œç›¸ä¿¡èƒ½æœ‰ä¸€äº›å¥½ç©çš„ä¸œè¥¿ã€‚**æ²¡æœ‰å°è¯•ï¼Œæ²¡æœ‰åŠªåŠ›ï¼Œå°±åƒä¸‡åˆ«åœ¨èµ·ç‚¹å°±æ”¾å¼ƒäº†**ã€‚æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæœ‰ä»€ä¹ˆæƒ³æ³•ï¼Œç›´æ¥æ‰¾æˆ‘ä¸€èµ·æ¢è®¨å“ˆã€‚ğŸ™ƒ~~

> Tips:
> 
> çœ‹åšä¸»å†™å¾—è¿™ä¹ˆè¾›è‹¦ä¸‹ï¼Œè·ªæ±‚ç‚¹èµã€å…³æ³¨ã€Starï¼[æ›´å¤šæ–‡ç« çŒ›æˆ³ ->](https://github.com/xd-tayde/blog) 
> 
> é‚®ç®±: 159042708@qq.com  å¾®ä¿¡/QQ: 159042708

**[ç¥ç¦#æ„Ÿæ©#æ­¦æ±‰åŠ æ²¹##RIP KOBE#]()**



